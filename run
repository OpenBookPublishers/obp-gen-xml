#!/usr/bin/env bash

set -e

cleanup () {
    local rv=$?
    rm -rf -- "$work_dir"
    exit $rv
}

trap cleanup EXIT

convert () {
    cd $work_dir

    echo "running XML-before-transformation.py"
    python2.7 XML-before-transformation.py

    echo "running Transform-to-XML-section.xsl"
    saxonb-xslt -s:Transform-to-XML-section.xsl \
		-xsl:Transform-to-XML-section.xsl \
		-o:Transform-to-XML-section.xsl \
		-ext:on

    echo "creating Transform-to-XML-section_tailored.xsl"
    python3 tailor_book_transform.py

    echo "running Transform-to-XML-section_tailored.xsl"
    saxonb-xslt -s:Transform-to-XML-book_tailored.xsl \
		-xsl:Transform-to-XML-book_tailored.xsl \
		-xi:on \
		-ext:on

    echo "running XML-after-transformation.py"
    python2.7 XML-after-transformation.py

    # Create a zip archive of the XML edition
    find . -name '*.zip' | while read file; do
	filename=$(basename -- ${file%.*})
	zip -rq ${filename}.xml.zip XML-edition/

	echo "created ./${filename}.xml.zip"
    done
}

work_dir=$(mktemp -d -t obp-gen-xml-XXXXXX)

echo "Copy relevant files to work directory"
# We need to revise the way how these files get picked up
cp *.epub $work_dir
cp *.xml $work_dir
cp tailor_book_transform.py $work_dir
cp -r XML-last/. $work_dir

cd $(dirname $0)
source .venv/bin/activate

(convert)

cp $work_dir/*.xml.zip .
